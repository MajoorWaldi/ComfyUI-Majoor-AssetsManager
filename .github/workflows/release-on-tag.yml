name: Create Stable Release

on:
  push:
    tags:
      - "v*.*.*" # Se déclenche sur les tags comme v1.0.0, v0.2.1, etc.

permissions: {}

jobs:
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          submodules: true

      - name: Create Archive
        # Réutilisation de la logique d'exclusion du ps1
        run: |
          zip -r ComfyUI-Majoor-AssetsManager_release.zip . \
          -x "*.git/*" \
          -x ".github/*" \
          -x ".claude/*" \
          -x "*/__pycache__/*" \
          -x "node_modules/*" \
          -x "*/.pytest_cache/*" \
          -x "tests/*" \
          -x "scripts/make_release_zip.ps1" \
          -x "*.zip"

      - name: Create Release
        uses: softprops/action-gh-release@f43927f8b9f890f7c14835e6ca0844af754a128d
        with:
          files: ComfyUI-Majoor-AssetsManager_release.zip
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Intégration de votre workflow existant pour publier aussi sur le registre Comfy
  publish-registry:
    needs: create-release
    name: Publish to Comfy Registry
    runs-on: ubuntu-latest
    permissions:
      contents: read
    # Condition extraite de votre fichier publish.yml original
    if: ${{ github.repository_owner == 'MajoorWaldi' }} 
    steps:
      - name: Check out code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          submodules: true
      - name: Publish Custom Node
        uses: Comfy-Org/publish-node-action@7578cdb0c1410f2515e6f9b1443c6859cab94f05 # 1.0.1
        with:
          personal_access_token: ${{ secrets.REGISTRY_ACCESS_TOKEN }}
